{% extends "deadlines/base.html" %}
{% load static %}

{% block title %}Documents - Business Deadlines{% endblock %}

{% block nav_documents %}active{% endblock %}

{% block content %}
<div class="header">
  <div class="header-row">
    <h1>Documents</h1>
    <div class="header-actions">
    </div>
  </div>
  <div class="entity-filter" style="display: flex; gap: 8px; flex-wrap: wrap; margin-top: 8px;">
    <select onchange="applyFilters()" id="entity-filter" class="filter-dropdown">
      <option value="">All Entities</option>
      {% for entity in entities %}
      <option value="{{ entity.entity_code }}" {% if entity.entity_code == entity_filter %}selected{% endif %}>
        {{ entity.entity_code }}
      </option>
      {% endfor %}
    </select>
    <select onchange="applyFilters()" id="type-filter" class="filter-dropdown">
      <option value="">All Types</option>
      {% for code, name in doctype_choices %}
      <option value="{{ code }}" {% if code == type_filter %}selected{% endif %}>
        {{ name }}
      </option>
      {% endfor %}
    </select>
    <select onchange="applyFilters()" id="source-filter" class="filter-dropdown">
      <option value="">All Sources</option>
      {% for code, name in sources %}
      <option value="{{ code }}" {% if code == source_filter %}selected{% endif %}>
        {{ name }}
      </option>
      {% endfor %}
    </select>
  </div>
</div>

<!-- Stats -->
<div class="stats">
  <div class="stat">
    <div class="stat-number" style="color: #6366f1;">{{ stats.total }}</div>
    <div class="stat-label">Total</div>
  </div>
  <div class="stat">
    <div class="stat-number" style="color: #3b82f6;">{{ stats.email }}</div>
    <div class="stat-label">Email</div>
  </div>
  <div class="stat">
    <div class="stat-number" style="color: #22c55e;">{{ stats.upload }}</div>
    <div class="stat-label">Upload</div>
  </div>
  <div class="stat">
    <div class="stat-number" style="color: #f97316;">{{ stats.scan }}</div>
    <div class="stat-label">Scan</div>
  </div>
</div>

<style>
  .doc-card {
    background: #f8f9fa;
    padding: 15px;
    margin: 10px 14px;
    border-radius: 8px;
    border: 1px solid #e5e7eb;
    text-decoration: none;
    color: inherit;
    display: block;
    transition: all 0.15s;
  }
  .doc-card:hover {
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
    transform: translateY(-1px);
  }
  .doc-card.email { border-left: 4px solid #3b82f6; }
  .doc-card.upload { border-left: 4px solid #22c55e; }
  .doc-card.scan { border-left: 4px solid #f97316; }
  .doc-title {
    font-weight: 600;
    font-size: 15px;
    color: #1f2937;
    margin-bottom: 5px;
    display: -webkit-box;
    -webkit-line-clamp: 2;
    -webkit-box-orient: vertical;
    overflow: hidden;
  }
  .doc-detail {
    font-size: 13px;
    color: #6b7280;
    margin: 3px 0;
  }
  .doc-badges {
    display: flex;
    flex-wrap: wrap;
    gap: 6px;
    margin-top: 10px;
  }
  .entity-badge {
    display: inline-block;
    background: #f3f4f6;
    color: #6b7280;
    padding: 2px 8px;
    border-radius: 10px;
    font-size: 10px;
    font-weight: 600;
  }
  .type-badge {
    display: inline-block;
    background: #e5e7eb;
    color: #374151;
    padding: 2px 8px;
    border-radius: 10px;
    font-size: 10px;
    font-weight: 600;
  }
  .source-badge {
    display: inline-block;
    padding: 2px 8px;
    border-radius: 10px;
    font-size: 10px;
    font-weight: 600;
  }
  .source-email { background: #dbeafe; color: #1d4ed8; }
  .source-upload { background: #dcfce7; color: #166534; }
  .source-scan { background: #ffedd5; color: #c2410c; }
  .sidebar-panel {
    min-width: 180px;
    padding: 12px;
    background: #f3f4f6;
    border-radius: 8px;
  }
  .sidebar-panel h3 {
    font-size: 14px;
    margin-bottom: 12px;
    color: #374151;
  }
  .type-filter-item {
    display: flex;
    justify-content: space-between;
    padding: 8px;
    margin-bottom: 4px;
    border-radius: 4px;
    text-decoration: none;
    color: #374151;
    transition: background 0.1s;
  }
  .type-filter-item:hover {
    background: #e5e7eb;
  }
  .type-filter-item.active {
    background: #e5e7eb;
    font-weight: 600;
  }
  .type-filter-count {
    background: #ddd;
    padding: 2px 8px;
    border-radius: 10px;
    font-size: 12px;
  }
  .empty-state-small {
    text-align: center;
    padding: 60px 20px;
    color: #9ca3af;
    font-size: 14px;
  }
  @media (min-width: 1024px) {
    .doc-card { margin: 0; }
    .documents-layout {
      display: grid;
      grid-template-columns: 200px 1fr;
      gap: 20px;
      padding: 24px;
    }
    .documents-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(320px, 1fr));
      gap: 16px;
    }
  }
  @media (max-width: 1023px) {
    .documents-layout {
      display: block;
    }
    .documents-grid {
      display: block;
    }
    .sidebar-panel {
      display: none;
    }
  }
</style>

<div class="content">
  <div class="documents-layout">
    <!-- Sidebar with type counts -->
    <div class="sidebar-panel">
      <h3>By Type</h3>
      {% for tc in type_counts %}
      <a href="?document_type={{ tc.document_type }}{% if entity_filter %}&entity={{ entity_filter }}{% endif %}{% if source_filter %}&source={{ source_filter }}{% endif %}"
         class="type-filter-item {% if tc.document_type == type_filter %}active{% endif %}">
        <span>{{ tc.display_name }}</span>
        <span class="type-filter-count">{{ tc.count }}</span>
      </a>
      {% empty %}
      <div style="color: #9ca3af; font-size: 13px;">No documents</div>
      {% endfor %}
    </div>

    <!-- Document Grid -->
    <div class="documents-main">
      {% if documents %}
      <div class="documents-grid">
        {% for document in documents %}
        <a href="{% url 'deadlines:document_detail' document.pk %}" class="doc-card {{ document.source }}">
          <div class="doc-title">{% if document.title %}{{ document.title }}{% else %}{{ document.filename }}{% endif %}</div>
          <div class="doc-detail">{{ document.filename|truncatechars:50 }}</div>
          <div class="doc-detail">{{ document.created_at|date:"M j, Y" }} &middot; {{ document.file_size_display }}</div>
          <div class="doc-badges">
            <span class="type-badge">{{ document.get_document_type_display }}</span>
            <span class="source-badge source-{{ document.source }}">{{ document.source|upper }}</span>
            {% if document.entity %}
            <span class="entity-badge">{{ document.entity.entity_code }}</span>
            {% endif %}
          </div>
        </a>
        {% endfor %}
      </div>
      {% else %}
      <div class="empty-state-small">
        <p>üìÅ</p>
        <p>No documents found.</p>
        {% if entity_filter or type_filter or source_filter %}
        <p style="margin-top: 10px;">
          <a href="{% url 'deadlines:document_list' %}" style="color: #6366f1; text-decoration: none;">
            Clear filters
          </a>
        </p>
        {% endif %}
      </div>
      {% endif %}
    </div>
  </div>
</div>

<script>
function applyFilters() {
  const entity = document.getElementById('entity-filter').value;
  const type = document.getElementById('type-filter').value;
  const source = document.getElementById('source-filter').value;

  let url = '{% url "deadlines:document_list" %}?';
  const params = [];

  if (entity) params.push('entity=' + encodeURIComponent(entity));
  if (type) params.push('document_type=' + encodeURIComponent(type));
  if (source) params.push('source=' + encodeURIComponent(source));

  window.location.href = url + params.join('&');
}
</script>
{% endblock %}
