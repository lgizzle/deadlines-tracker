{% extends "deadlines/base.html" %}
{% load static %}

{% block title %}{{ entity.entity_code }} - Business Deadlines{% endblock %}
{% block nav_entities %}active{% endblock %}
{% block bottom_nav_entities %}active{% endblock %}

{% block content %}
<div class="detail-header">
  <a href="{% url 'deadlines:entity_list' %}" class="detail-back"
    >‚Üê Back to Entities</a
  >
  <div class="detail-title">{{ entity.entity_code }}</div>
  <div class="detail-meta">
    <span class="detail-entity-badge">{{ entity.physical_state }}</span>
    <span>{{ entity.dba_name|default:entity.legal_name }}</span>
  </div>
</div>

<div class="tabs entity-tabs" style="background: #5558e3">
  <a
    href="?tab=overview"
    class="tab {% if active_tab == 'overview' %}active{% endif %}"
    style="color: rgba(255, 255, 255, 0.7)"
    >Overview</a
  >
  <a
    href="?tab=financial"
    class="tab {% if active_tab == 'financial' %}active{% endif %}"
    style="color: rgba(255, 255, 255, 0.7)"
    >Financial</a
  >
  <a
    href="?tab=insurance"
    class="tab {% if active_tab == 'insurance' %}active{% endif %}"
    style="color: rgba(255, 255, 255, 0.7)"
    >Insurance</a
  >
  <a
    href="?tab=licenses"
    class="tab {% if active_tab == 'licenses' %}active{% endif %}"
    style="color: rgba(255, 255, 255, 0.7)"
    >Licenses</a
  >
  <a
    href="?tab=deadlines"
    class="tab {% if active_tab == 'deadlines' %}active{% endif %}"
    style="color: rgba(255, 255, 255, 0.7)"
    >Deadlines</a
  >
  <a
    href="?tab=contacts"
    class="tab {% if active_tab == 'contacts' %}active{% endif %}"
    style="color: rgba(255, 255, 255, 0.7)"
    >Contacts</a
  >
</div>

<style>
  .tabs .tab.active {
    color: white !important;
    border-bottom-color: white;
  }
  .financial-item {
    background: #f8f9fa;
    padding: 12px;
    margin: 8px 0;
    border-radius: 6px;
    border-left: 3px solid #6366f1;
  }
  .financial-item-header {
    font-weight: 600;
    margin-bottom: 6px;
    color: #1f2937;
  }
  .financial-item-detail {
    font-size: 12px;
    color: #6b7280;
    margin: 3px 0;
  }
  .contact-card {
    background: #f8f9fa;
    padding: 15px;
    margin: 10px 0;
    border-radius: 8px;
    border: 1px solid #e5e7eb;
  }
  .contact-name {
    font-weight: 600;
    font-size: 15px;
    color: #1f2937;
    margin-bottom: 5px;
  }
  .contact-detail {
    font-size: 13px;
    color: #6b7280;
    margin: 3px 0;
  }
  .empty-state-small {
    text-align: center;
    padding: 30px;
    color: #9ca3af;
    font-size: 13px;
  }
</style>

<div class="detail-content">
  {% if active_tab == 'overview' %}
  <!-- Overview Tab -->
  <div class="detail-card">
    <h3>Business Information</h3>
    <div class="detail-grid">
      <div class="detail-field">
        <span class="detail-label">Legal Name</span>
        <span class="detail-value">{{ entity.legal_name }}</span>
      </div>
      {% if entity.dba_name %}
      <div class="detail-field">
        <span class="detail-label">DBA</span>
        <span class="detail-value">{{ entity.dba_name }}</span>
      </div>
      {% endif %}
      <div class="detail-field">
        <span class="detail-label">Entity Type</span>
        <span class="detail-value">{{ entity.entity_type|default:"N/A" }}</span>
      </div>
      <div class="detail-field">
        <span class="detail-label">State</span>
        <span class="detail-value">{{ entity.physical_state }}</span>
      </div>
      {% if entity.ein %}
      <div class="detail-field">
        <span class="detail-label">EIN</span>
        <span class="detail-value" style="font-family: monospace"
          >{{ entity.ein }}</span
        >
      </div>
      {% endif %}
{% if entity.sos_number %}
      <div class="detail-field">
        <span class="detail-label">SOS Number</span>
        <span class="detail-value" style="font-family: monospace"
          >{{ entity.sos_number }}</span
        >
      </div>
      {% endif %}
    </div>
  </div>

  {% if entity.physical_address %}
  <div class="detail-card">
    <h3>Address</h3>
    <p
      style="
        font-size: 14px;
        color: #333;
        line-height: 1.6;
        margin-bottom: 12px;
      "
    >
      {{ entity.physical_address }}<br />
      {{ entity.physical_city }}, {{ entity.physical_state }} {{ entity.physical_zip }}
    </p>
    <div style="display: flex; gap: 12px">
      <a
        href="https://maps.google.com/?q={{ entity.physical_address }},{{ entity.physical_city }},{{ entity.physical_state }}"
        target="_blank"
        style="font-size: 12px; color: #6366f1; text-decoration: none"
        >üó∫Ô∏è Open in Maps</a
      >
    </div>
  </div>
  {% endif %}
{% if entity.manager_name %}
  <div class="detail-card">
    <h3>Management</h3>
    <div class="contact-card">
      <div class="contact-name">{{ entity.manager_name }}</div>
      <div class="contact-detail">Manager</div>
      {% if entity.manager_phone %}
      <div class="contact-detail" style="margin-top: 8px">
        <a
          href="tel:{{ entity.manager_phone }}"
          style="color: #6366f1; text-decoration: none"
          >üìû {{ entity.manager_phone }}</a
        >
      </div>
      {% endif %}
{% if entity.manager_email %}
      <div class="contact-detail">
        <a
          href="mailto:{{ entity.manager_email }}"
          style="color: #6366f1; text-decoration: none"
          >‚úâÔ∏è {{ entity.manager_email }}</a
        >
      </div>
      {% endif %}
    </div>
  </div>
  {% endif %}
{% elif active_tab == 'financial' %}
  <!-- Financial Tab -->
  <div class="detail-card">
    <h3>Bank Accounts</h3>
    {% if bank_accounts %}
{% for account in bank_accounts %}
    <div class="financial-item">
      <div class="financial-item-header">
        {{ account.bank_name }} - {{ account.account_type }}
      </div>
      <div class="financial-item-detail">
        Account: ‚Ä¢‚Ä¢‚Ä¢‚Ä¢ {{ account.account_number_last4 }}
      </div>
      {% if account.routing_number %}
      <div class="financial-item-detail">
        Routing: {{ account.routing_number }}
      </div>
      {% endif %}
{% if account.notes %}
      <div class="financial-item-detail">{{ account.notes }}</div>
      {% endif %}
    </div>
    {% endfor %}
{% else %}
    <div class="empty-state-small">No bank accounts on file</div>
    {% endif %}
  </div>

  <div class="detail-card">
    <h3>Credit Cards</h3>
    {% if credit_cards %}
{% for card in credit_cards %}
    <div class="financial-item">
      <div class="financial-item-header">{{ card.card_name }}</div>
      <div class="financial-item-detail">
        ‚Ä¢‚Ä¢‚Ä¢‚Ä¢ {{ card.last4 }}{% if card.network %} ({{ card.network }}){% endif %}
      </div>
      {% if card.credit_limit %}
      <div class="financial-item-detail">
        Limit: ${{ card.credit_limit|floatformat:0 }}
      </div>
      {% endif %}
{% if card.notes %}
      <div class="financial-item-detail">{{ card.notes }}</div>
      {% endif %}
    </div>
    {% endfor %}
{% else %}
    <div class="empty-state-small">No credit cards on file</div>
    {% endif %}
  </div>

  <div class="detail-card">
    <h3>Loans</h3>
    {% if loans %}
{% for loan in loans %}
    <div class="financial-item">
      <div class="financial-item-header">
        {{ loan.loan_type }} - {{ loan.lender }}
      </div>
      {% if loan.account_number %}
      <div class="financial-item-detail">
        Account: {{ loan.account_number }}
      </div>
      {% endif %}
{% if loan.current_balance %}
      <div class="financial-item-detail">
        Balance: ${{ loan.current_balance|floatformat:2 }}
      </div>
      {% endif %}
{% if loan.payment_amount %}
      <div class="financial-item-detail">
        Payment: ${{ loan.payment_amount|floatformat:2 }} {{
        loan.payment_frequency }}
      </div>
      {% endif %}
{% if loan.maturity_date %}
      <div class="financial-item-detail">
        Maturity: {{ loan.maturity_date|date:"M j, Y" }}
      </div>
      {% endif %}
    </div>
    {% endfor %}
{% else %}
    <div class="empty-state-small">No loans on file</div>
    {% endif %}
  </div>

  <div class="detail-card">
    <h3>Merchant Processors</h3>
    {% if merchant_processors %}
    {% for processor in merchant_processors %}
    <div class="financial-item">
      <div class="financial-item-header">{{ processor.processor_name }}</div>
      {% if processor.merchant_id %}
      <div class="financial-item-detail">Merchant ID: {{ processor.merchant_id }}</div>
      {% endif %}
      {% if processor.terminal_id %}
      <div class="financial-item-detail">Terminal ID: {{ processor.terminal_id }}</div>
      {% endif %}
      {% if processor.dba_name %}
      <div class="financial-item-detail">DBA: {{ processor.dba_name }}</div>
      {% endif %}
      {% if processor.portal_url %}
      <div class="financial-item-detail">
        <a href="{{ processor.portal_url }}" target="_blank" style="color: #6366f1; text-decoration: none">üîó Portal</a>
      </div>
      {% endif %}
      {% if processor.notes %}
      <div class="financial-item-detail">{{ processor.notes }}</div>
      {% endif %}
    </div>
    {% endfor %}
    {% else %}
    <div class="empty-state-small">No merchant processors on file</div>
    {% endif %}
  </div>

  <div class="detail-card">
    <h3>State Accounts</h3>
    {% if state_accounts %}
    {% for account in state_accounts %}
    <div class="financial-item">
      <div class="financial-item-header">{{ account.state }} - {{ account.account_type }}</div>
      {% if account.account_number %}
      <div class="financial-item-detail">Account #: {{ account.account_number }}</div>
      {% endif %}
      {% if account.portal_name %}
      <div class="financial-item-detail">Portal: {{ account.portal_name }}</div>
      {% endif %}
      {% if account.portal_url %}
      <div class="financial-item-detail">
        <a href="{{ account.portal_url }}" target="_blank" style="color: #6366f1; text-decoration: none">üîó {{ account.portal_name|default:"Login" }}</a>
      </div>
      {% endif %}
      {% if account.notes %}
      <div class="financial-item-detail">{{ account.notes }}</div>
      {% endif %}
    </div>
    {% endfor %}
    {% else %}
    <div class="empty-state-small">No state accounts on file</div>
    {% endif %}
  </div>

  <div class="detail-card">
    <h3>Vendors</h3>
    {% if vendors %}
    {% for vendor in vendors %}
    <div class="financial-item">
      <div class="financial-item-header">{{ vendor.vendor_name }}</div>
      {% if vendor.account_number %}
      <div class="financial-item-detail">Account: {{ vendor.account_number }}</div>
      {% endif %}
      {% if vendor.purpose %}
      <div class="financial-item-detail">Purpose: {{ vendor.purpose }}</div>
      {% endif %}
      {% if vendor.service_location %}
      <div class="financial-item-detail">Location: {{ vendor.service_location }}</div>
      {% endif %}
      {% if vendor.contact_phone %}
      <div class="financial-item-detail">
        <a href="tel:{{ vendor.contact_phone }}" style="color: #6366f1; text-decoration: none">üìû {{ vendor.contact_phone }}</a>
      </div>
      {% endif %}
      {% if vendor.notes %}
      <div class="financial-item-detail">{{ vendor.notes }}</div>
      {% endif %}
    </div>
    {% endfor %}
    {% else %}
    <div class="empty-state-small">No vendors on file</div>
    {% endif %}
  </div>

  {% elif active_tab == 'insurance' %}
  <!-- Insurance Tab -->
  <div class="detail-card">
    <h3>Insurance Policies</h3>
    {% if insurance_policies %}
{% for policy in insurance_policies %}
    <div class="financial-item">
      <div class="financial-item-header">
        {{ policy.policy_type }} - {{ policy.carrier }}
      </div>
      <div class="financial-item-detail">
        Policy #: {{ policy.policy_number }}
      </div>
      {% if policy.coverage_amount %}
      <div class="financial-item-detail">
        Coverage: ${{ policy.coverage_amount|floatformat:0 }}
      </div>
      {% endif %}
{% if policy.premium_amount %}
      <div class="financial-item-detail">
        Premium: ${{ policy.premium_amount|floatformat:2 }}
      </div>
      {% endif %}
{% if policy.renewal_date %}
      <div class="financial-item-detail">
        Renewal: {{ policy.renewal_date|date:"M j, Y" }}
      </div>
      {% endif %}
{% if policy.notes %}
      <div class="financial-item-detail">{{ policy.notes }}</div>
      {% endif %}
    </div>
    {% endfor %}
{% else %}
    <div class="empty-state-small">No insurance policies on file</div>
    {% endif %}
  </div>

  {% elif active_tab == 'licenses' %}
  <!-- Licenses Tab -->
  <div class="detail-card">
    <h3>Licenses & Permits</h3>
    {% if licenses %}
{% for license in licenses %}
    <div class="financial-item">
      <div class="financial-item-header">{{ license.license_type }}</div>
      <div class="financial-item-detail">
        License #: {{ license.license_number }}
      </div>
      <div class="financial-item-detail">
        Issuing Authority: {{ license.issuing_authority }}
      </div>
      {% if license.expiration_date %}
      <div class="financial-item-detail">
        Expires: {{ license.expiration_date|date:"M j, Y" }}
      </div>
      {% endif %}
{% if license.renewal_fee %}
      <div class="financial-item-detail">
        Renewal Fee: ${{ license.renewal_fee|floatformat:2 }}
      </div>
      {% endif %}
{% if license.notes %}
      <div class="financial-item-detail">{{ license.notes }}</div>
      {% endif %}
    </div>
    {% endfor %}
{% else %}
    <div class="empty-state-small">No licenses on file</div>
    {% endif %}
  </div>

  {% elif active_tab == 'deadlines' %}
  <!-- Deadlines Tab -->
  <div class="detail-card">
    <h3>Active Deadlines</h3>
    {% if deadlines %}
{% for deadline in deadlines %}
    <a
      href="{% url 'deadlines:deadline_detail' deadline.pk %}"
      class="list-item {{ deadline.urgency_status }}"
      style="display: block; margin: 8px 0"
    >
      <div class="list-item-title">{{ deadline.title }}</div>
      <div class="list-item-meta">
        <span
          >{{ deadline.category }} ¬∑ {{ deadline.get_frequency_display }}</span
        >
        <span class="list-item-date">{{ deadline.next_due|date:"M j" }}</span>
      </div>
    </a>
    {% endfor %}
    <div style="text-align: center; margin-top: 15px">
      <a
        href="{% url 'deadlines:list' %}?entity={{ entity.entity_code }}"
        style="color: #6366f1; text-decoration: none; font-size: 13px"
        >View All Deadlines ‚Üí</a
      >
    </div>
    {% else %}
    <div class="empty-state-small">No active deadlines</div>
    {% endif %}
  </div>

  {% elif active_tab == 'contacts' %}
  <!-- Contacts Tab -->
  <div class="detail-card">
    <h3>Contacts</h3>
    {% if contacts %}
{% for contact in contacts %}
    <div class="contact-card">
      <div class="contact-name">{{ contact.full_name }}</div>
      {% if contact.title %}
      <div class="contact-detail">{{ contact.title }}</div>
      {% endif %}
{% if contact.company_name %}
      <div class="contact-detail">{{ contact.company_name }}</div>
      {% endif %}
      <div
        class="contact-detail"
        style="color: #9ca3af; font-size: 11px; margin-top: 5px"
      >
        {{ contact.contact_type }}
      </div>
      {% if contact.email %}
      <div class="contact-detail" style="margin-top: 8px">
        <a
          href="mailto:{{ contact.email }}"
          style="color: #6366f1; text-decoration: none"
          >‚úâÔ∏è {{ contact.email }}</a
        >
      </div>
      {% endif %}
{% if contact.phone %}
      <div class="contact-detail">
        <a
          href="tel:{{ contact.phone }}"
          style="color: #6366f1; text-decoration: none"
          >üìû {{ contact.phone }}</a
        >
      </div>
      {% endif %}
{% if contact.mobile %}
      <div class="contact-detail">
        <a
          href="tel:{{ contact.mobile }}"
          style="color: #6366f1; text-decoration: none"
          >üì± {{ contact.mobile }}</a
        >
      </div>
      {% endif %}
    </div>
    {% endfor %}
{% else %}
    <div class="empty-state-small">No contacts on file</div>
    {% endif %}
  </div>

  {% endif %}
</div>
{% endblock %}
